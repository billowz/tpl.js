!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("_"),require("jquery"),require("observer")):"function"==typeof define&&define.amd?define(["_","jquery","observer"],e):"object"==typeof exports?exports.tpl=e(require("_"),require("jquery"),require("observer")):t.tpl=e(t._,t.jQuery,t.observer)}(this,function(t,e,n){return function(t){function e(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";var i=n(1);i.Directives=n(11),t.exports=i},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},r=n(2),s=n(3),c=n(4),p=n(8),a=n(9),u={delimiter:["{","}"],directivePrefix:"tpl-"},h=0,l=function(){function t(e,n){i(this,t),this.template=s(e),this.cfg=r.assign(r.clone(u),n||{});var o=this.cfg.delimiter[0],c=this.cfg.delimiter[1];this.delimiterReg=new RegExp(o+"([^"+o+c+"]*)"+c,"g"),this.attrDirectiveTestReg=new RegExp("^"+this.cfg.directivePrefix),this.__instance_nr__=0,this.__id__=h++}return t.prototype.complie=function(t,e){return new f(this,t,e)},t}(),f=function(){function t(e,n,o){i(this,t),this.tpl=e,this.scope=n,this.el=this.tpl.template.clone(),this.cfg=e.cfg,this.parent=o,this.__id__=e.__id__+"-"+e.__instance_nr__++,this.init()}return t.prototype.renderTo=function(t){return s(t).append(this.el),this},t.prototype.init=function(){var t=this;this.bindings=this.parse(this.el),this.bindings.forEach(function(e){e.bind(),t.scope=e.getScope()})},t.prototype.parse=function(t){var e=this;if(!(t.jquery||t instanceof Array))return this.parseEl(t);var n=function(){var n=[];return r.each(t,function(t){n.push.apply(n,e.parseEl(t))}),{v:n}}();return"object"===("undefined"==typeof n?"undefined":o(n))?n.v:void 0},t.prototype.parseEl=function(t){switch(t.nodeType){case 1:return this.parseElement(t);case 3:return this.parseText(t)}},t.prototype.parseText=function(t){for(var e=t.data,n=void 0,i=0,o=this.tpl.delimiterReg,r=[];n=o.exec(e);)this.createTextNode(e.substring(i,o.lastIndex-n[0].length),t),n[1]&&r.push(new c(this.createTextNode("binding",t),this,n[1])),i=o.lastIndex;return this.createTextNode(e.substr(i),t),s(t).remove(),r},t.prototype.createTextNode=function(t,e){if(t=r.trim(t)){var n=document.createTextNode(t);return s(n).insertBefore(e),n}},t.prototype.parseElement=function(t){var e=this,n=!1,i=(s(t),[]),o=[],c=[];if(t.attributes){r.each(t.attributes,function(t){var i=t.name,r=t.value,s=void 0;if((i=e.parseDirectiveName(i))&&(s=p.getDirective(i))){if(s.prototype["abstract"])return o=[{"const":s,val:r}],n=!0,!1;o.push({"const":s,val:r}),s.prototype.block&&(n=!0)}else i&&console.warn("Directive is undefined "+t.name)});for(var u=0;u<o.length;u++)c.push(new o[u]["const"](t,this,o[u].val));c.length>1?i.push(new a(t,this,c)):1==c.length&&i.push(c[0])}return n||i.push.apply(i,this.parseChildNodes(t)),i},t.prototype.parseChildNodes=function(t){return this.parse(r.slice(t.childNodes,0))},t.prototype.parseDirectiveName=function(t){var e=this.tpl.attrDirectiveTestReg;return e.test(t)?t.replace(e,""):void 0},t}();t.exports=l},function(e,n){e.exports=t},function(t,n){t.exports=e},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var s=(n(2),n(3)),c=n(5),p=n(6),a=p.Expression,u=function(t){function e(n,r,s){i(this,e);var c=o(this,t.call(this,r));return c.el=n,c.expr=s,c.update=c.update.bind(c),c.expression=new a(c.scope,s,c.update),c}return r(e,t),e.prototype.bind=function(){c.genComment&&!this.comment&&(this.comment=s(document.createComment("Text Binding "+this.expr)),this.comment.insertBefore(this.el)),this.scope=this.expression.observe(this.update),this.update(this.expression.value())},e.prototype.unbind=function(){this.scope=this.expression.unobserve()},e.prototype.update=function(t){void 0!==t&&null!==t||(t=""),this.el.data=t},e}(c);t.exports=u},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o=(n(2),function(){function t(e){i(this,t),this.tpl=e,this.scope=e.scope}return t.prototype.bind=function(){throw"Abstract Method ["+this.constructor.name+".bind]"},t.prototype.unbind=function(){throw"Abstract Method ["+this.constructor.name+".unbind]"},t.prototype.getScope=function(){return this.scope},t}());o.genComment=!0,t.exports=o},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0;var o=n(2),r=n(7);e.Expression=function(){function t(e,n,o){i(this,t),this.scope=e,this.expr=n,this.filters=[],this.handler=o,this.__listen=this.__listen.bind(this)}return t.prototype.realValue=function(){return o.get(this.scope,this.expr)},t.prototype.setRealValue=function(t){o.set(this.scope,this.expr,t)},t.prototype.value=function(){for(var t=o.get(this.scope,this.expr),e=0;e<this.filters.length;e++)t=this.filters[e].apply(t);return t},t.prototype.setValue=function(t){for(var e=0;e<this.filters.length;e++)t=this.filters[e].unapply(t);o.set(this.scope,this.expr,t)},t.prototype.observe=function(){return this.scope=r.on(this.scope,this.expr,this.__listen),this.scope},t.prototype.unobserve=function(){return this.scope=r.un(this.scope,this.expr,this.__listen),this.scope},t.prototype.__listen=function(t,e){for(var n=0;n<this.filters.length;n++)e=this.filters[n].apply(e);this.handler(e)},t}()},function(t,e){t.exports=n},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},c=n(2),p=n(3),a=n(5),u="extend",h=function(t){function e(n,r,s){i(this,e);var c=o(this,t.call(this,r));return c.el=n,c.$el=p(n),c.expr=s,c.attr=r.cfg.directivePrefix+c.name,c}return r(e,t),e.prototype.getPriority=function(){return this.priority},e.prototype.isBlock=function(){return this.block},e.prototype.bind=function(){a.genComment&&!this.comment&&(this.comment=p(document.createComment(" Directive:"+this.name+" ["+this.expr+"] ")),this.comment.insertBefore(this.el))},e.prototype.unbind=function(){},e}(a);h.prototype["abstract"]=!1,h.prototype.name="Unkown",h.prototype.block=!1,h.prototype.priority=0;var l={},f=h.isDirective=function(t){var e="undefined"==typeof t?"undefined":s(t);if(!t||"function"!=e&&"object"!=e)return!1;for(var n=t;n=Object.getPrototypeOf(n);)if(n===h)return!0;return!1};h.register=function(t,e){t in l&&console.warn("Directive["+t+"] is defined");var n=void 0;if(c.isPlainObject(e))n=function(t,e){var n=t[u];if(n&&!f(n))throw"Invalid Directive SuperClass "+n;e=n||e;var i=c.isFunction(t.constructor)?t.constructor:void 0,o=function(){var t=function(){if(!(this instanceof e))throw new TypeError("Cannot call a class as a function");e.apply(this,arguments),i&&i.apply(this,arguments)};return t}();return o.prototype=Object.create(e.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),delete t.constructor,delete t[u],c.each(t,function(t,e){o.prototype[e]=t}),Object.setPrototypeOf(o,e),o}(e,h),n.prototype.className=c.capitalize(t)+"Directive";else{if(!f(e))throw TypeError("Invalid Directive Object "+e);n=e,n.prototype.className=n.prototype.constructor.name}return n.prototype.name=t,l[t]=n,n},h.getDirective=function(t){return l[t]};t.exports=h},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var s=n(5),c=n(10),p=c.ArrayIterator,a=c.YieId,u=function(t){function e(n,r,s){i(this,e);var c=o(this,t.call(this,r));return c.el=n,c.directives=s,c.directives.sort(function(t,e){return e.priority-t.priority||0}),c}return r(e,t),e.prototype.bind=function(){function t(){for(var i=void 0,o=void 0;e.hasNext();)if(i=e.next(),o=i.bind(),n.scope=i.getScope(),e.hasNext()&&o&&o instanceof a){o.then(t);break}}var e=new p(this.directives),n=this;t()},e.prototype.unbind=function(){var t=this;this.directives.forEach(function(e){e.unbind(),t.scope=e.getScope()})},e}(s);t.exports=u},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o=n(2),r=function(){function t(){i(this,t),this._doned=!1,this._thens=[]}return t.prototype.then=function(t){o.include(this._thens,t)||this._thens.push(t)},t.prototype.done=function(){this._doned||(o.each(this._thens,function(t){return t()}),this._doned=!0)},t.prototype.isDone=function(){return this._doned},t}(),s=function(){function t(e,n){i(this,t),this.array=e,this.index=n||0}return t.prototype.hasNext=function(){return this.index<this.array.length},t.prototype.next=function(){return this.array[this.index++]},t}();t.exports={YieId:r,ArrayIterator:s}},function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(e,n){var i=p.register(e,n);t.exports[i.prototype.className]=i}e.__esModule=!0;var c=n(2),p=n(8),a=n(1),u=n(6),h=u.Expression,l=n(10),f=l.YieId,d=e.AbstractEventDirective=function(t){function e(n,r,s){i(this,e);var c=o(this,t.call(this,n,r,s));return c.handler=c.handler.bind(c),c}return r(e,t),e.prototype.handler=function(t){var e=c.get(this.scope,this.expr);if("function"!=typeof e)throw TypeError("Invalid Event Handler ");e.call(this.scope,t,t.target,this.scope)},e.prototype.bind=function(){t.prototype.bind.call(this),this.$el.on(this.eventType,this.handler)},e.prototype.unbind=function(){t.prototype.unbind.call(this),this.$el.un(this.eventType,this.handler)},e}(p),y=["blur","change","click","dblclick","error","focus","keydown","keypress","keyup","load","mousedown","mousemove","mouseout","mouseover","mouseup","resize","scroll","select","submit","unload",{name:"oninput",eventType:"input propertychange"}];c.each(y,function(t){var e=void 0;c.isString(t)?(e="on"+t,t={eventType:t}):e=t.name,t.extend=d,s(e,t)});var v=e.AbstractExpressionDirective=function(t){function e(n,r,s){i(this,e);var c=o(this,t.call(this,n,r,s));return c.update=c.update.bind(c),c.expression=new h(c.scope,c.expr,c.update),c}return r(e,t),e.prototype.bind=function(){t.prototype.bind.call(this),this.scope=this.expression.observe(),this.update(this.value())},e.prototype.unbind=function(){this.scope=this.expression.unobserve()},e.prototype.setRealValue=function(t){return this.expression.setRealValue(t)},e.prototype.setValue=function(t){return this.expression.setValue(t)},e.prototype.realValue=function(){return this.expression.realValue()},e.prototype.value=function(){return this.expression.value()},e.prototype.blankValue=function(t){return 0==arguments.length&&(t=this.expression.value()),void 0===t||null==t?"":t},e.prototype.update=function(t){throw"Abstract Method ["+this.className+".update]"},e}(p),b="change",m="input propertychange",x="click",_="SELECT",g="INPUT",w="TEXTAREA",E="radio",T="checkbox",k={text:{update:function(t){this.$el.text(this.blankValue(t))},block:!0},html:{update:function(t){this.$el.html(this.blankValue(t))},block:!0},"class":{update:function(t){var e=this.blankValue(t);this.oldCls&&this.$el.removeClass(this.oldCls),this.$el.addClass(e),this.oldCls=e}},show:{update:function(t){this.$el.css("display",t?"":"none")}},hide:{update:function(t){this.$el.css("display",t?"none":"")}},value:{update:function(t){this.$el.val(this.blankValue(t))}},"if":{bind:function(){return v.prototype.bind.call(this),this.directives?void 0:(this.yieId=new f,this.yieId)},update:function(t){var e=this;t?(this.directives||(this.directives=this.tpl.parseChildNodes(this.el),this.directives.forEach(function(t){t.bind(),e.scope=t.getScope()}),this.yieId&&(this.yieId.done(),delete this.yieId)),this.$el.css("display","")):this.$el.css("display","none")},unbind:function(){var t=this;v.prototype.unbind.call(this),this.directives&&this.directives.forEach(function(e){e.unbind(),t.scope=e.getScope()})},priority:9,block:!0},input:{constructor:function(t,e,n){v.call(this,t,e,n),this.onChange=this.onChange.bind(this);var i=this.tag=t.tagName;switch(i){case _:this.event=b;break;case g:var o=this.type=t.type;this.event=o==E||o==T?x:m;break;case w:throw TypeError("Directive[input] not support "+i);default:throw TypeError("Directive[input] not support "+i)}},bind:function(){v.prototype.bind.call(this),this.$el.on(this.event,this.onChange)},unbind:function(){v.prototype.unbind.call(this),this.$el.un(this.event,this.onChange)},onChange:function(){var t=this.elVal();t!=this.val&&this.setValue(t)},update:function(t){this.val=this.blankValue(t),this.elVal(this.val)},elVal:function(t){var e=this.tag;switch(e){case _:break;case g:var n=this.type;if(n==E||n==T){if(0==arguments.length)return this.$el.prop("checked")?this.$el.val():void 0;var i=c.isString(t)?t==this.$el.val():!!t;this.$el.prop("checked")!=i&&this.$el.prop("checked",i)}else{if(0==arguments.length)return this.$el.val();t!=this.$el.val()&&this.$el.val(t)}break;case w:throw TypeError("Directive[input] not support "+e);default:throw TypeError("Directive[input] not support "+e)}}}};c.each(k,function(t,e){t.extend=v,s(e,t)});var C=/^\s*([\S][\s\S]+[\S])\s+in\s+([\S]+)(\s+track\s+by\s+([\S]+))?\s*$/,S=/^(\(\s*([\S]+)(\s*,\s*([\S]+))?\s*\))|([\S]+)(\s*,\s*([\S]+))$/,j=e.EachDirective=function(t){function e(n,r,s){i(this,e);var c=o(this,t.call(this,n,r,s));c.__listen=c.__listen.bind(c),c.__lenListen=c.__lenListen.bind(c);var p=s.match(C);if(!p)throw Error("Invalid Expression["+s+"] on Each Directive");c.scopeExpr=p[2],c.indexExpr=p[4];var u=p[1].match(S);if(!u)throw Error("Invalid Expression["+p[1]+"] on Each Directive");return c.valueAlias=u[2]||u[5],c.keyAlias=u[4]||u[7],c.$parentEl=c.$el.parent(),c.$el.remove().removeAttr(c.attr),c.childTpl=new a(c.$el),c}return r(e,t),e.prototype.bindChild=function(t,e){var n={};this.keyAlias&&(n[this.keyAlias]=t),n[this.valueAlias]=e,console.log("bindChild",t,n,this.el);this.childTpl.complie(n).renderTo(this.$parentEl)},e.prototype.bind=function(){t.prototype.bind.call(this),this.scope=observer.on(this.scope,this.scopeExpr,this.__listen),this.scope=observer.on(this.scope,this.scopeExpr+".length",this.__lenListen),this.update(c.get(this.scope,this.scopeExpr))},e.prototype.update=function(t){if(!(t instanceof Array))throw Error("Invalid Each Scope["+this.scopeExpr+"]");for(var e=0;e<t.length;e++)this.bindChild(e,t[e])},e.prototype.unbind=function(){t.prototype.unbind.call(this),this.scope=observer.un(this.scope,this.scopeExpr,this.__listen),this.scope=observer.un(this.scope,this.scopeExpr+".length",this.__lenListen)},e.prototype.__listen=function(t,e){this.update(e)},e.prototype.__lenListen=function(t,e){this.update(c.get(this.scope,this.scopeExpr))},e}(p);j.prototype["abstract"]=!0,j.prototype.block=!0,j.prototype.priority=10,p.register("each",j)}])});